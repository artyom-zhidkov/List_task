<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>List Task Prototype</title>
</head>
<body>
    <script src="handlebars-v4.0.12.js"></script>
    <script id="list-template" type="text/x-handlebars-template">
        <button id="button_add_task">add task</button>
        <input id="input_content" type="text">
        <br>
        <ul id="unordered_list">
            {{#each tasks}}
                {{#if completed}}
                    <li id="{{id}}" style="text-decoration: line-through;">{{name}}</li>
                {{else}}
                    <li id="{{id}}" style="text-decoration: none;">{{name}}</li>
                {{/if}}
            {{/each}}
        </ul>
        <button id="button_remove_all">remove all</button>
        <button id="status_completed">{{valueButtonCompleted}}</button>
    </script>
       
    <script>
        var tasks = JSON.parse(localStorage.getItem('tasks')) || [];
        var indicateCompleted = JSON.parse(localStorage.getItem('indicateCompleted')) || false;
        var valueButtonCompleted = indicateCompleted ? "show completed" : "hide completed";
        var source   = document.getElementById("list-template").innerHTML;
        var template = Handlebars.compile(source);
      
        renderTasksAsHTML(getTasks(tasks, indicateCompleted));

        function renderTasksAsHTML(tasks) {
            document.body.innerHTML = template({ tasks : getTasks(tasks, indicateCompleted) , valueButtonCompleted});
            listenTasksClick(tasks);
            addEventListenerForAllButton();
        }
        
        function listenTasksClick(tasks) {
            document
                .querySelectorAll('#unordered_list li')
                .forEach(function(element, index) {
                element.addEventListener('click', function(event) {
                    var tasks1 = handleTaskClick(element, tasks);
                    writeToLocalStorageTasks(tasks1);
                    renderTasksAsHTML(tasks1);
                });
            });
        }
        
        function handleTaskClick(element, tasks) {
            var taskId = element.id;
            tasks.forEach(function(task, i, arr){
                if (taskId == task.id) {
                    arr[i].completed = !arr[i].completed
                };
            });
            return tasks;
        }
        
        function toggleCompletedTasks (tasks) {
            indicateCompleted = !indicateCompleted;
            valueButtonCompleted = changeButtonValue(tasks, indicateCompleted);
            renderTasksAsHTML(getTasks(tasks, indicateCompleted));
            writeToLocalStorageTasks();
        }
        
        function changeButtonValue (tasks, needFilter) {
            indicateCompletedInListNow = tasks.every(function(task) {
               return !task.completed;
            });
            if (indicateCompletedInListNow) return "show completed";
            return needFilter ? "show completed" : "hide completed";
        }
        
        function getTasks(tasks, needFilter) { 
            return tasks.filter(function(task) {
                return !needFilter ? true: !task.completed;
            });
        }
        
        function getRandomIdForTask() {
            var result       = '';
            var words        = '0123456789qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM';
            var max_position = words.length - 1;
                for( i = 0; i < 5; ++i ) {
                    position = Math.floor ( Math.random() * max_position );
                    result += words.substring(position, position + 1);
                }
            return result;
        }
        
        function addListElement(e) {
            var input_content = document.getElementById('input_content').value;
 
            var task = {
                id: getRandomIdForTask(),
                name: input_content,
                completed: false
            }

            if (input_content) {
                tasks.push(task);
                clearInput();         
                writeToLocalStorageTasks();
                renderTasksAsHTML(tasks);
            }
        }
        
        function removeAllElement(tasks) {
            tasks = [];
            renderTasksAsHTML(tasks);
            writeToLocalStorageTasks();
        }
        
        function pushButton(e) {
            if (event.keyCode == 13) addListElement();
        }
        
        function clearInput() {
            document.getElementById('input_content').value = '';
        }
        
        function writeToLocalStorageTasks() {
            localStorage.setItem('tasks',JSON.stringify(tasks));
            localStorage.setItem('indicateCompleted',JSON.stringify(indicateCompleted));
        }

        function addEventListenerForAllButton() {
            document.getElementById('button_add_task').addEventListener('click',addListElement);
            document.getElementById('button_remove_all').addEventListener('click',removeAllElement);
            document.getElementById('status_completed').addEventListener('click',function() {toggleCompletedTasks(tasks)});
            document.getElementById('input_content').addEventListener('keyup',pushButton);
        }
        
    </script>
</body>
</html>



